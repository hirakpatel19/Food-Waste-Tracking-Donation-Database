{% extends "base.html" %}

{% block title %}Browse Food Donations - Food Waste Tracker{% endblock %}

{% block content %}
<div class="container py-4">
    <!-- Page Header -->
    <div class="row mb-4">
        <div class="col-12">
            <h1><i class="bi bi-search"></i> Browse Food Donations</h1>
            <p class="lead text-muted">Find available food donations in your area</p>
        </div>
    </div>
    
    <!-- Search and Filters -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <form method="GET" class="row g-3">
                        <div class="col-md-4">
                            <label class="form-label">Search</label>
                            <input type="text" name="search" class="form-control" 
                                   placeholder="Search food items..." 
                                   value="{{ current_filters.search }}">
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">Category</label>
                            <select name="category_id" class="form-select">
                                <option value="0">All Categories</option>
                                {% for category in categories %}
                                <option value="{{ category.id }}" 
                                        {{ 'selected' if current_filters.category_id == category.id }}>
                                    {{ category.name }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">City</label>
                            <input type="text" name="city" class="form-control" 
                                   placeholder="City" 
                                   value="{{ current_filters.city }}">
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">Dietary</label>
                            <select name="dietary_info" class="form-select">
                                <option value="">Any</option>
                                <option value="vegetarian" {{ 'selected' if current_filters.dietary_info == 'vegetarian' }}>Vegetarian</option>
                                <option value="vegan" {{ 'selected' if current_filters.dietary_info == 'vegan' }}>Vegan</option>
                                <option value="gluten-free" {{ 'selected' if current_filters.dietary_info == 'gluten-free' }}>Gluten-Free</option>
                                <option value="halal" {{ 'selected' if current_filters.dietary_info == 'halal' }}>Halal</option>
                                <option value="kosher" {{ 'selected' if current_filters.dietary_info == 'kosher' }}>Kosher</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">&nbsp;</label>
                            <div class="d-grid">
                                <button type="submit" class="btn btn-success">
                                    <i class="bi bi-search"></i> Search
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Results -->
    {% if donations.items %}
    <div class="row mb-3">
        <div class="col-12">
            <p class="text-muted">
                Showing {{ donations.items|length }} of {{ donations.total }} donations
                {% if donations.pages > 1 %}(Page {{ donations.page }} of {{ donations.pages }}){% endif %}
            </p>
        </div>
    </div>
    
    <div class="row">
        {% for donation in donations.items %}
        <div class="col-md-6 col-lg-4 mb-4">
            <div class="card h-100 donation-card">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <h5 class="card-title">{{ donation.title }}</h5>
                        <span class="badge bg-{{ donation.get_status_class() }}">{{ donation.status.title() }}</span>
                    </div>
                    
                    <p class="text-muted small mb-2">
                        <i class="bi bi-tag"></i> {{ donation.category.name }}
                    </p>
                    
                    <p class="card-text">{{ donation.description[:100] }}{% if donation.description|length > 100 %}...{% endif %}</p>
                    
                    <div class="row text-center mb-3">
                        <div class="col-6">
                            <strong class="text-success">{{ donation.quantity }} {{ donation.unit }}</strong>
                            <br><small class="text-muted">Quantity</small>
                        </div>
                        <div class="col-6">
                            <strong class="{{ 'text-warning' if donation.is_urgent() else 'text-info' }}">
                                {{ donation.days_until_expiry() }} days
                            </strong>
                            <br><small class="text-muted">Until expiry</small>
                        </div>
                    </div>
                    
                    <div class="mb-2">
                        <small class="text-muted">
                            <i class="bi bi-geo-alt"></i> {{ donation.pickup_city }}
                        </small>
                    </div>
                    
                    {% if donation.dietary_info %}
                    <div class="mb-2">
                        <span class="badge bg-info">{{ donation.dietary_info.title() }}</span>
                    </div>
                    {% endif %}
                    
                    {% if donation.is_urgent() %}
                    <div class="alert alert-warning alert-sm mb-2">
                        <i class="bi bi-exclamation-triangle"></i> <strong>Urgent!</strong> Expires soon
                    </div>
                    {% endif %}
                </div>
                
                <div class="card-footer bg-transparent">
                    {% if current_user.is_authenticated and current_user.is_ngo() %}
                        <a href="{{ url_for('ngo.view_donation', id=donation.id) }}" class="btn btn-outline-success w-100">
                            <i class="bi bi-eye"></i> View Details
                        </a>
                    {% else %}
                        <small class="text-muted">Sign in as NGO to claim donations</small>
                    {% endif %}
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    
    <!-- Pagination -->
    {% if donations.pages > 1 %}
    <nav aria-label="Donations pagination">
        <ul class="pagination justify-content-center">
            {% if donations.has_prev %}
                <li class="page-item">
                    <a class="page-link" href="{{ url_for('main.browse_donations', page=donations.prev_num) }}">
                        <i class="bi bi-chevron-left"></i> Previous
                    </a>
                </li>
            {% endif %}
            
            {% for page_num in donations.iter_pages() %}
                {% if page_num %}
                    {% if page_num != donations.page %}
                        <li class="page-item">
                            <a class="page-link" href="{{ url_for('main.browse_donations', page=page_num) }}">{{ page_num }}</a>
                        </li>
                    {% else %}
                        <li class="page-item active">
                            <span class="page-link">{{ page_num }}</span>
                        </li>
                    {% endif %}
                {% else %}
                    <li class="page-item disabled">
                        <span class="page-link">...</span>
                    </li>
                {% endif %}
            {% endfor %}
            
            {% if donations.has_next %}
                <li class="page-item">
                    <a class="page-link" href="{{ url_for('main.browse_donations', page=donations.next_num) }}">
                        Next <i class="bi bi-chevron-right"></i>
                    </a>
                </li>
            {% endif %}
        </ul>
    </nav>
    {% endif %}
    
    {% else %}
    <!-- No Results -->
    <div class="text-center py-5">
        <i class="bi bi-search display-3 text-muted mb-3"></i>
        <h3>No donations found</h3>
        <p class="text-muted">Try adjusting your search criteria or check back later for new donations.</p>
        {% if not current_user.is_authenticated %}
            <a href="{{ url_for('auth.register') }}" class="btn btn-success">
                <i class="bi bi-person-plus"></i> Join as Donor to Add Food
            </a>
        {% elif current_user.is_donor() %}
            <a href="{{ url_for('donor.add_donation') }}" class="btn btn-success">
                <i class="bi bi-plus-circle"></i> Add Food Donation
            </a>
        {% endif %}
    </div>
    {% endif %}
</div>
{% endblock %}